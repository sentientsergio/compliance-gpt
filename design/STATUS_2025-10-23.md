# Design Status Summary - October 23, 2025

## Completed Today

### Three Critical Design Documents Created

1. **[Prompt Management Architecture](llm_strategy/prompt_management.md)**
   - Externalization strategy (no hardcoded prompts)
   - Approval workflow (AI drafts → Sergio reviews → approve → deploy)
   - Versioning and evolution (v1 → v2 → v3 based on Red Team findings)
   - Integration with code (PromptLoader pattern)
   - Testing and validation strategy

2. **[Semantic Fingerprinting Strategy](reconciliation/semantic_fingerprinting.md)**
   - What to include: Legal concepts, regulatory refs, section context (heading text)
   - What to exclude: Section/question numbers, page refs, vendor branding
   - Prevents embedding pollution (Age Q 1.04 ≠ State Q 4.01 false positive)
   - Implementation with caching strategy
   - Red Team Sprint validation criteria

3. **[Variance Classification Model](data_models/variance_model.md)**
   - Three types: Administrative / Design / Regulatory
   - Four impact levels: High / Medium / Low / None
   - Classification decision tree
   - Comprehensive examples including market research HCE safe harbor case
   - Exception log integration (Design + High/Medium → auto-escalate)

### Previously Created (Oct 23)

4. **[Provisional Matching Model](data_models/provisional_matching.md)**
   - Three-level matching: Template / Election / Instance
   - "The template is not the instance" principle
   - Match validation workflow
   - Confidence scoring with provisional penalties (-15% pending, -40% blocked)

5. **[Performance Optimization Strategy](performance_optimization.md)**
   - Current baseline: 39 minutes
   - MVP target: 20 minutes (49% reduction)
   - AsyncIO architecture recommended
   - Tier 1/2/3 optimizations with time/cost savings
   - Cost analysis: $8.47 → $6.30 per conversion

6. **[Design Directory Audit](AUDIT_2025-10-23.md)**
   - Document-by-document review
   - Identified gaps and inconsistencies
   - Action plan for updates

---

## Design Folder Structure (Updated)

```
/design/
├── README.md                              # Needs update with new docs
├── STATUS_2025-10-23.md                  # This file
├── AUDIT_2025-10-23.md                   # Audit report
├── performance_optimization.md            # NEW (Oct 23)
│
├── architecture/
│   └── system_architecture.md            # Needs review for async/await
│
├── data_models/
│   ├── provision_model.md                # Needs integration with provisional matching
│   ├── mapping_model.md                  # Needs integration with provisional matching
│   ├── crosswalk_model.md                # Existing
│   ├── provisional_matching.md           # NEW (Oct 23) ✅
│   └── variance_model.md                 # NEW (Oct 23) ✅
│
├── llm_strategy/
│   ├── README.md                         # Existing
│   ├── model_selection.md                # Existing
│   ├── decision_matrix.md                # Existing
│   ├── llm_research_report.md            # Existing
│   └── prompt_management.md              # NEW (Oct 23) ✅
│
├── reconciliation/                       # NEW DIRECTORY
│   └── semantic_fingerprinting.md        # NEW (Oct 23) ✅
│
└── modules/                               # Future - module design docs
```

---

## What's Now Foundation for Prompt Revisions

All three new design documents directly inform the extraction prompt revisions:

### 1. Prompt Management → HOW we revise prompts
- Externalization (load from `/prompts/*.txt`)
- Approval workflow (Sergio reviews before deployment)
- Versioning (v3 → v4 with documented rationale)
- Testing (Red Team Sprint validation)

### 2. Semantic Fingerprinting → WHAT we extract
- **Exclude section headings without content** ← Critical fix for Red Team finding
- Preserve section context (heading text, not numbers)
- Extract provision types (for smart candidate filtering)
- Strip structural artifacts before embedding

### 3. Variance Model → WHY we care about quality
- Design variances with High impact can't be missed
- Real-world example: HCE safe harbor inclusion (market research)
- Classification depends on accurate extraction
- Exception log auto-population from variances

---

## Next Steps (Ready to Execute)

### Immediate: Revise Extraction Prompts

**`provision_extraction_v3 → v4`**:
- Add explicit rule: "Do not extract section headings without substantive content"
- Add provision type classification (eligibility_rule, contribution_formula, definition, etc.)
- Add section context preservation (heading text without numbers)
- Request: Include full provision text, not summaries
- Example: "REQUIRED MINIMUM DISTRIBUTIONS" with no text → SKIP

**`aa_extraction_v3 → v4` (if needed)**:
- Review current version for section heading issues
- Ensure question number is metadata, not part of semantic content
- Validate election kind-based structure is working

### After Extraction: Re-run Pipeline

1. Extract with revised prompts (v4)
2. Apply semantic fingerprinting (strip numbers)
3. Generate embeddings (batch, cached)
4. Run crosswalks (BPD + AA in parallel)
5. Confirm provisional matches (Step 3 workflow)
6. Classify variances (use variance model)

### Validation: Red Team Sprint on Extraction Quality

**Exit Criteria** (before semantic mapping validation):
- ✅ Zero section headings in provision corpus
- ✅ All provisions have substantive content
- ✅ Section context included correctly (heading text, no numbers)
- ✅ Provision types assigned ≥90% accuracy
- ✅ No false positives from embedding pollution (<30% similarity for unrelated provisions)

---

## Design Debt (Tracked but Deferred)

### Short-Term (After Extraction Fixes)
- Update `/design/README.md` with Phase 2 status and new docs
- Update `provision_model.md` to reference provisional matching
- Update `mapping_model.md` to reference provisional matching
- Review `system_architecture.md` for async/await integration

### Medium-Term (MVP Preparation)
- Create module design docs (extraction, reconciliation, output)
- Document deployment model (Docker, AsyncIO, etc.)
- Formalize Red Team Sprint methodology in design

---

## Key Insights from Today's Work

1. **"The template is not the instance"** - Provisional matching captures this elegantly
2. **Prompt management is architecture, not implementation** - Deserves design-level documentation
3. **Semantic fingerprinting solves embedding pollution** - Defense in depth with prompt warnings
4. **Variance classification prevents real-world errors** - HCE safe harbor example proves value
5. **Design before prompts** - Having these three docs makes prompt revision straightforward

---

## Summary for Sergio

**What We Accomplished (Option A):**
✅ Created all three critical design documents
✅ Established prompt management strategy
✅ Defined semantic fingerprinting rules
✅ Specified variance classification model
✅ Documented provisional matching model
✅ Analyzed performance optimization strategy
✅ Audited design directory for consistency

**Ready for Option B:**
- All conceptual foundations in place
- Clear guidance for prompt revisions
- Red Team Sprint validation criteria defined
- Can now move quickly into extraction fixes

**Time Invested:** ~4 hours design documentation
**Time Saved:** Weeks of rework from unclear requirements

**Next Session:** Revise extraction prompts (v3 → v4) based on these design foundations, then re-run pipeline.

---

*Status as of: 2025-10-23, 3:00 PM*
*All design docs pending Sergio's review and approval*
